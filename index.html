<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø± Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ Ø§Ù„Ø°ÙƒÙŠ âœ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: white; }
        .card { background: #1e293b; border-radius: 24px; border: 1px solid #334155; }
        .gradient-indigo { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .active-tab { background: #6366f1; color: white; border-color: #6366f1; }
        input[type="text"], input[type="file"] { background: #0f172a; border: 1px solid #334155; color: white; }
        .loading-bar { height: 6px; background: #6366f1; width: 0%; transition: width 0.4s ease-in-out; }
    </style>
</head>
<body class="p-4 md:p-10 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold mb-3 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">âœ¨ Ø£Ø¯Ø§Ø© ØµÙ†Ø§Ø¹Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯</h1>
            <p class="text-gray-400 text-sm">Ø£Ø¯Ø§Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ ÙˆØ§Ù„Ø¯Ù…Ø¬ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</p>
            
            <div id="statusBox" class="mt-8 hidden max-w-lg mx-auto bg-slate-800 p-4 rounded-2xl border border-slate-700">
                <div class="w-full bg-slate-900 rounded-full h-2 mb-2">
                    <div id="progressBar" class="loading-bar rounded-full"></div>
                </div>
                <p id="statusMsg" class="text-xs text-indigo-300 font-bold animate-pulse text-center"></p>
            </div>
        </header>

        <div class="flex flex-wrap justify-center gap-3 mb-8">
            <button onclick="switchTab('cut')" id="tab-cut" class="tab-btn active-tab border border-slate-600 px-6 py-3 rounded-xl font-bold transition">ğŸµ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ MP3</button>
            <button onclick="switchTab('mix')" id="tab-mix" class="tab-btn border border-slate-600 px-6 py-3 rounded-xl font-bold transition">ğŸ¬ Ø¯Ù…Ø¬ Ø±ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
            <button onclick="switchTab('reel')" id="tab-reel" class="tab-btn border border-slate-600 px-6 py-3 rounded-xl font-bold transition">ğŸ“± Smart Reel</button>
        </div>

        <div class="card p-8 shadow-2xl">
            
            <div id="sec-cut" class="space-y-6">
                <h2 class="text-xl font-bold text-indigo-400 border-r-4 border-indigo-500 pr-3">Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØµÙˆØª Ø§Ù„Ù‚ØµÙŠØ¯Ø©</h2>
                <div class="space-y-4">
                    <label class="block text-sm text-gray-400">Ø§Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù‚ØµÙŠØ¯Ø©:</label>
                    <input type="file" id="f-cut" accept="video/*" class="w-full p-2 rounded-lg cursor-pointer">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="s-cut" placeholder="Ù…Ù† (Ù…Ø«Ù„Ø§Ù‹ 01:20)" class="p-4 rounded-xl text-center font-mono outline-none focus:border-indigo-500">
                        <input type="text" id="e-cut" placeholder="Ø¥Ù„Ù‰ (Ù…Ø«Ù„Ø§Ù‹ 01:50)" class="p-4 rounded-xl text-center font-mono outline-none focus:border-indigo-500">
                    </div>
                    <button onclick="runTask('mp3')" class="gradient-indigo w-full py-4 rounded-2xl font-bold text-lg shadow-lg hover:brightness-110 transition">ØªØ­ÙˆÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„ MP3</button>
                </div>
            </div>

            <div id="sec-mix" class="hidden space-y-6">
                <h2 class="text-xl font-bold text-blue-400 border-r-4 border-blue-500 pr-3">Ø¯Ù…Ø¬ Ø§Ù„ØµÙˆØª Ù…Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø®Ù„ÙÙŠØ©</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs text-gray-400">ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù‚ØµÙŠØ¯Ø© (Ù„Ù„ØµÙˆØª):</label>
                        <input type="file" id="f-mix-audio" accept="video/*" class="w-full text-xs p-2 rounded-lg">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-gray-400">ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù„Ù„ØµÙˆØ±Ø©):</label>
                        <input type="file" id="f-mix-video" accept="video/*" class="w-full text-xs p-2 rounded-lg">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="s-mix" placeholder="Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙˆØª (00:10)" class="p-4 rounded-xl text-center font-mono outline-none">
                    <input type="text" id="e-mix" placeholder="Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙˆØª (00:40)" class="p-4 rounded-xl text-center font-mono outline-none">
                </div>
                <button onclick="runTask('mix')" class="bg-blue-600 w-full py-4 rounded-2xl font-bold text-lg hover:bg-blue-700 transition shadow-lg">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø±ÙŠÙ„ Ø§Ù„Ù…Ø¯Ù…Ø¬</button>
            </div>

            <div id="sec-reel" class="hidden space-y-6">
                <h2 class="text-xl font-bold text-green-400 border-r-4 border-green-500 pr-3">Smart Reel (ØªØªØ¨Ø¹ Ø§Ù„ÙƒØ§Ø¯Ø±)</h2>
                <div class="space-y-4">
                    <label class="block text-sm text-gray-400">Ø§Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ:</label>
                    <input type="file" id="f-reel" accept="video/*" class="w-full p-2 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="s-reel" placeholder="Ù…Ù† (01:00)" class="p-4 rounded-xl text-center font-mono outline-none">
                        <input type="text" id="e-reel" placeholder="Ø¥Ù„Ù‰ (01:30)" class="p-4 rounded-xl text-center font-mono outline-none">
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl text-xs text-green-300 italic border border-green-900/30">
                        ğŸ’¡ Ù…ÙŠØ²Ø© Ø§Ù„ØªØªØ¨Ø¹: Ø³ÙŠØªÙ… Ù‚Øµ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„ÙŠÙƒÙˆÙ† Ø·ÙˆÙ„ÙŠØ§Ù‹ (9:16) Ù…Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ù…Ù†ØªØµÙ Ø§Ù„ÙƒØ§Ø¯Ø±.
                    </div>
                    <button onclick="runTask('smart')" class="bg-green-600 w-full py-4 rounded-2xl font-bold text-lg hover:bg-green-700 transition shadow-lg">Ø¥Ù†ØªØ§Ø¬ Ø±ÙŠÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        function switchTab(tab) {
            ['cut', 'mix', 'reel'].forEach(t => {
                document.getElementById('sec-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('active-tab');
            });
            document.getElementById('sec-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('active-tab');
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø°ÙƒÙŠ
        function toSec(str) {
            if(!str) return 0;
            const p = str.trim().replace(/[^0-9:]/g, '').split(':').reverse();
            let s = 0;
            if(p[0]) s += parseInt(p[0]);
            if(p[1]) s += parseInt(p[1]) * 60;
            if(p[2]) s += parseInt(p[2]) * 3600;
            return s;
        }

        async function runTask(mode) {
            const statusBox = document.getElementById('statusBox');
            const statusMsg = document.getElementById('statusMsg');
            const progressBar = document.getElementById('progressBar');
            
            let start, end, f1, f2, out = "output.mp4";

            try {
                if(mode === 'mp3') {
                    f1 = document.getElementById('f-cut').files[0];
                    start = toSec(document.getElementById('s-cut').value);
                    end = toSec(document.getElementById('e-cut').value);
                    out = "poem_audio.mp3";
                } else if(mode === 'mix') {
                    f1 = document.getElementById('f-mix-audio').files[0];
                    f2 = document.getElementById('f-mix-video').files[0];
                    start = toSec(document.getElementById('s-mix').value);
                    end = toSec(document.getElementById('e-mix').value);
                    out = "mixed_reel.mp4";
                } else {
                    f1 = document.getElementById('f-reel').files[0];
                    start = toSec(document.getElementById('s-reel').value);
                    end = toSec(document.getElementById('e-reel').value);
                    out = "smart_reel.mp4";
                }

                if(!f1 || (end-start) <= 0) { alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ÙˆÙ‚Øª!"); return; }

                statusBox.classList.remove('hidden');
                statusMsg.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
                progressBar.style.width = "20%";

                if (!ffmpeg.isLoaded()) await ffmpeg.load();
                
                statusMsg.innerText = "Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª...";
                progressBar.style.width = "40%";
                ffmpeg.FS('writeFile', 'in1', await fetchFile(f1));
                if(f2) ffmpeg.FS('writeFile', 'in2', await fetchFile(f2));

                statusMsg.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (Ø§Ù„ØªÙ„ÙˆÙŠØ² Ø´ØºØ§Ù„)...";
                progressBar.style.width = "70%";

                if(mode === 'mp3') {
                    await ffmpeg.run('-ss', start.toString(), '-i', 'in1', '-t', (end-start).toString(), '-q:a', '0', '-map', 'a', out);
                } else if(mode === 'mix') {
                    await ffmpeg.run('-i', 'in2', '-ss', start.toString(), '-i', 'in1', '-t', (end-start).toString(), 
                                     '-vf', 'crop=ih*(9/16):ih:(iw-ow)/2:0,scale=720:1280', '-map', '0:v', '-map', '1:a', '-c:v', 'libx264', '-shortest', out);
                } else {
                    await ffmpeg.run('-ss', start.toString(), '-i', 'in1', '-t', (end-start).toString(), 
                                     '-vf', 'crop=ih*(9/16):ih:(iw-ow)/2:0,scale=720:1280', '-c:v', 'libx264', out);
                }

                progressBar.style.width = "100%";
                statusMsg.innerText = "Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©! Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

                const data = ffmpeg.FS('readFile', out);
                const url = URL.createObjectURL(new Blob([data.buffer], { type: mode==='mp3'?'audio/mp3':'video/mp4' }));
                const a = document.createElement('a');
                a.href = url; a.download = out; a.click();

            } catch (e) {
                console.error(e);
                statusMsg.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª COOP/COEP)";
            }
        }
    </script>
</body>
</html>
