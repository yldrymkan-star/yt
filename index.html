<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø± Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: white; }
        .card { background: #1e293b; border-radius: 20px; border: 1px solid #334155; }
        .gradient-btn { background: linear-gradient(90deg, #6366f1 0%, #a855f7 100%); transition: 0.3s; }
        .gradient-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-style { background: #0f172a; border: 1px solid #334155; padding: 12px; border-radius: 12px; outline: none; text-align: center; width: 100%; }
        .input-style:focus { border-color: #6366f1; }
        .tab-btn { padding: 10px 20px; border-radius: 10px; transition: 0.3s; font-weight: bold; }
        .active-tab { background: #6366f1; color: white; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold mb-3 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">âœ¨ Ø£Ø¯Ø§Ø© Ù…Ø­Ø±Ø± Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p class="text-gray-400">Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆÙÙ„Ø§ÙŠÙ† (Smart Crop & Audio Extract)</p>
            
            <div id="statusContainer" class="mt-6 hidden max-w-md mx-auto">
                <div class="w-full bg-slate-800 rounded-full h-2.5 mb-2">
                    <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <p id="statusMsg" class="text-xs text-indigo-300 font-bold animate-pulse"></p>
            </div>
        </header>

        <div class="flex justify-center gap-4 mb-8">
            <button onclick="showSection('cut')" id="btn-cut" class="tab-btn active-tab border border-indigo-500">ğŸµ Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ MP3</button>
            <button onclick="showSection('mix')" id="btn-mix" class="tab-btn border border-slate-600">ğŸ¬ Ø¯Ù…Ø¬ Ø±ÙŠÙ„</button>
            <button onclick="showSection('reel')" id="btn-reel" class="tab-btn border border-slate-600">ğŸ“± ØªØ­ÙˆÙŠÙ„ Ø°ÙƒÙŠ</button>
        </div>

        <div id="cut-section" class="card p-8 shadow-2xl space-y-6">
            <h2 class="text-xl font-bold border-r-4 border-indigo-500 pr-3">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØª ÙÙ‚Ø·</h2>
            <input type="file" id="audioSource" accept="video/*" class="w-full text-sm text-slate-400 file:bg-indigo-600 file:text-white file:rounded-lg file:px-4 file:py-2 file:border-0">
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="start1" placeholder="Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (01:20)" class="input-style font-mono">
                <input type="text" id="end1" placeholder="Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (01:50)" class="input-style font-mono">
            </div>
            <button onclick="process('mp3')" id="mainBtn1" class="gradient-btn w-full py-4 rounded-xl font-bold text-lg shadow-lg">Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØª</button>
        </div>

        <div id="mix-section" class="card p-8 shadow-2xl hidden space-y-6">
            <h2 class="text-xl font-bold border-r-4 border-blue-500 pr-3">Ø¯Ù…Ø¬ ØµÙˆØª Ø§Ù„Ù‚ØµÙŠØ¯Ø© Ù…Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-xs text-gray-400">ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù‚ØµÙŠØ¯Ø© (Ù„Ù„ØµÙˆØª):</label>
                    <input type="file" id="mixAudioSource" accept="video/*" class="w-full text-xs">
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-gray-400">Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù„Ù„ØµÙˆØ±Ø©):</label>
                    <input type="file" id="mixVideoSource" accept="video/*" class="w-full text-xs">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="start2" placeholder="Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙˆØª (00:05)" class="input-style font-mono text-sm">
                <input type="text" id="end2" placeholder="Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙˆØª (00:30)" class="input-style font-mono text-sm">
            </div>
            <button onclick="process('mix')" id="mainBtn2" class="bg-blue-600 w-full py-4 rounded-xl font-bold text-lg hover:bg-blue-700 transition shadow-lg">Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø±ÙŠÙ„ Ø§Ù„Ù…Ø¯Ù…Ø¬</button>
        </div>

        <div id="reel-section" class="card p-8 shadow-2xl hidden space-y-6">
            <h2 class="text-xl font-bold border-r-4 border-green-500 pr-3">Smart Reel (ØªØªØ¨Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†Ø´Ø¯)</h2>
            <input type="file" id="reelSource" accept="video/*" class="w-full">
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="start3" placeholder="Ù…Ù† (01:10)" class="input-style font-mono">
                <input type="text" id="end3" placeholder="Ø¥Ù„Ù‰ (01:40)" class="input-style font-mono">
            </div>
            <p class="text-[10px] text-green-400 text-center italic font-bold">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù‚Øµ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„ÙŠÙƒÙˆÙ† Ø·ÙˆÙ„ÙŠØ§Ù‹ (9:16) Ù…Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ Ø§Ù„Ù…Ù†Ø´Ø¯.</p>
            <button onclick="process('smart')" id="mainBtn3" class="bg-green-600 w-full py-4 rounded-xl font-bold text-lg hover:bg-green-700 transition shadow-lg">ØªØ­ÙˆÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ÙŠÙ„</button>
        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù‚ÙˆÙŠØ©
        function timeToSec(str) {
            if (!str || typeof str !== 'string') return 0;
            const cleanStr = str.trim().replace(/[^0-9:]/g, '');
            const parts = cleanStr.split(':').reverse();
            let seconds = 0;
            if (parts[0]) seconds += parseInt(parts[0], 10) || 0;
            if (parts[1]) seconds += (parseInt(parts[1], 10) || 0) * 60;
            if (parts[2]) seconds += (parseInt(parts[2], 10) || 0) * 3600;
            return seconds;
        }

        function showSection(section) {
            ['cut', 'mix', 'reel'].forEach(s => {
                document.getElementById(s + '-section').classList.add('hidden');
                document.getElementById('btn-' + s).classList.remove('active-tab', 'border-indigo-500');
            });
            document.getElementById(section + '-section').classList.remove('hidden');
            document.getElementById('btn-' + section).classList.add('active-tab', 'border-indigo-500');
        }

        async function process(mode) {
            const statusContainer = document.getElementById('statusContainer');
            const statusMsg = document.getElementById('statusMsg');
            const progressBar = document.getElementById('progressBar');
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…Ø·
            let start, end, file1, file2, outputName;
            if(mode === 'mp3') {
                start = timeToSec(document.getElementById('start1').value);
                end = timeToSec(document.getElementById('end1').value);
                file1 = document.getElementById('audioSource').files[0];
                outputName = "audio_poem.mp3";
            } else if(mode === 'mix') {
                start = timeToSec(document.getElementById('start2').value);
                end = timeToSec(document.getElementById('end2').value);
                file1 = document.getElementById('mixAudioSource').files[0];
                file2 = document.getElementById('mixVideoSource').files[0];
                outputName = "mixed_reel.mp4";
            } else {
                start = timeToSec(document.getElementById('start3').value);
                end = timeToSec(document.getElementById('end3').value);
                file1 = document.getElementById('reelSource').files[0];
                outputName = "smart_reel.mp4";
            }

            const duration = end - start;
            if (!file1 || duration <= 0) { alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆÙƒØªØ§Ø¨Ø© Ø§Ù„ÙˆÙ‚Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!"); return; }

            try {
                statusContainer.classList.remove('hidden');
                statusMsg.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
                progressBar.style.width = "10%";

                if (!ffmpeg.isLoaded()) await ffmpeg.load();
                
                progressBar.style.width = "30%";
                statusMsg.innerText = "Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª... Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹";
                ffmpeg.FS('writeFile', 'input1.mp4', await fetchFile(file1));
                if(file2) ffmpeg.FS('writeFile', 'input2.mp4', await fetchFile(file2));

                statusMsg.innerText = "Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„ØªÙ„ÙˆÙŠØ² (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù)...";
                progressBar.style.width = "50%";

                if (mode === 'mp3') {
                    await ffmpeg.run('-ss', start.toString(), '-i', 'input1.mp4', '-t', duration.toString(), '-q:a', '0', '-map', 'a', outputName);
                } else if (mode === 'mix') {
                    await ffmpeg.run('-i', 'input2.mp4', '-ss', start.toString(), '-i', 'input1.mp4', '-t', duration.toString(), 
                                     '-vf', 'crop=ih*(9/16):ih:(iw-ow)/2:0,scale=720:1280', '-map', '0:v', '-map', '1:a', '-c:v', 'libx264', '-shortest', outputName);
                } else if (mode === 'smart') {
                    await ffmpeg.run('-ss', start.toString(), '-i', 'input1.mp4', '-t', duration.toString(), 
                                     '-vf', 'crop=ih*(9/16):ih:(iw-ow)/2:0,scale=720:1280', '-c:v', 'libx264', '-preset', 'ultrafast', outputName);
                }

                progressBar.style.width = "100%";
                statusMsg.innerText = "ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

                const data = ffmpeg.FS('readFile', outputName);
                const url = URL.createObjectURL(new Blob([data.buffer], { type: mode === 'mp3' ? 'audio/mp3' : 'video/mp4' }));
                const a = document.createElement('a');
                a.href = url;
                a.download = outputName;
                a.click();

            } catch (e) {
                console.error(e);
                statusMsg.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£! ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ± (COOP/COEP).";
            }
        }
    </script>
</body>
</html>
